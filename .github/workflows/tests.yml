name: Tests

on: [push, pull_request]

permissions:
  contents: read

defaults:
  run:
    shell: bash

# Notes:
# - Split docker build and publish steps
# - Should the docker image build use the prebuilt assets? (probably)
# -  How should this be done locally?
# -  Should some test run against the Docker container?
# - Should there be a tox test for building the docs?

jobs:

  #-------------------------
  #       Building
  #-------------------------

  build_package:
    name: Build and Cache Packages
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_git_tag.outputs.tag }}
      tag_short: ${{ steps.set_git_tag.outputs.tag_short }}
      branch: ${{ steps.set_git_branch.outputs.branch }}
      is_merge_commit: ${{ steps.set_git_is_merge_commit.outputs.is_merge_commit }}
      python_version: ${{ steps.set_python_version.outputs.python_version }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Python and Poetry and cache build dependencies
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          virtualenvs-path: .venv
          installer-parallel: true
          plugins: |
            poetry-dynamic-versioning[plugin]
            poethepoet[poetry_plugin]
    
      # Install and cache full build dependencies
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root --no-plugins

      # Install node and yarn in order to build the front end during packaging  
      - name: Set Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'yarn'
          cache-dependency-path: locust/webui/yarn.lock
      - name: Install Yarn
        run: npm install -g yarn

      # Build and upload the project artifacts
      - name: Build Python dist and web UI
        run: poetry build --no-interaction
      - name: Upload Python dist as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/*

      - name: Upload Web UI as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webui-dist
          path: locust/webui/dist/*
  
      - name: Build UI library
        run: yarn webui:build:lib
      - name: Upload web UI library as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webui-package-dist
          path: locust/webui/lib
      
      # Set workflow metadata in one place so we can pull it out later
      - id: set_tag
        run: echo "tag=$(poetry version -s)" >> "$GITHUB_OUTPUT"
      - id: set_tag_short
        run: echo "tag_short=$(poetry version -s | cut -d '.' -f1-3)" >> "$GITHUB_OUTPUT"
      - id: set_branch
        run: echo "branch=$(git branch -a --contains $(poetry version -s) | grep -v HEAD | cut -d '/' -f3)" >> "$GITHUB_OUTPUT"
      - id: set_is_merge_commit
        run: echo "is_merge_commit=$( [ $(git rev-list --count $GITHUB_SHA^@) -eq 2 ] && echo 'true' || echo 'false' )" >> "$GITHUB_OUTPUT"
      - id: set_python_version
        run: echo "python_version=$(python -VV | sha256sum | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

  docker_build:
    name: Docker - Build
    needs: build_package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Grab built Python dist for the Docker CI image
      - name: Download Python dist
        uses: actions/download-artifact@v4
        with:
          name: python-package-dist
          path: dist
      
      # Set up Docker daemon dependencies for building and publishing
      - uses: docker/login-action@v3
        if: github.repository_owner == 'locustio'
        with:
          username: locustbuild
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
    
      # Build and cache Docker image
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.ci
          tags: locustio/locust:latest
          outputs: type=docker,dest=/tmp/locust-docker.tar
          platforms: linux/amd64,linux/arm64

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: locust-docker
          path: /tmp/locust-docker.tar

  #-------------------------
  #       Testing
  #-------------------------

  tox_tests:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    needs: build_package

    strategy:
      fail-fast: false
      matrix:
        include:
          # Static analysis
          - { name: "Static Analysis: Ruff", python: "3.11", os: ubuntu-latest, tox: "ruff" }
          - { name: "Static Analysis: MyPy", python: "3.10", os: ubuntu-latest, tox: "mypy" }

          # OS Integration tests 
          - { name: "Integration Tests: Linux", python: "3.12", os: ubuntu-latest, tox: fail_fast_test_main_external_package }
          - {name: "Integration Tests: Windows", python: '3.12', os: windows-latest, tox: fail_fast_test_main_external_package }
          - {name: "Integration Tests: MacOS", python: '3.12', os: macos-latest, tox: fail_fast_test_main_external_package }
          
          # Unit tests on Python versions
          - { name: "Unit Tests: Python 3.12", python: "3.12", os: ubuntu-latest, tox: py312 }
          - { name: "Unit Tests: Python 3.11", python: "3.11", os: ubuntu-latest, tox: py311 }
          - { name: "Unit Tests: Python 3.10", python: "3.10", os: ubuntu-latest, tox: py310 }
          - { name: "Unit Tests: Python 3.9", python: "3.9", os: ubuntu-latest, tox: py39 }

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Python and Poetry
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          virtualenvs-path: .venv
          installer-parallel: true
          plugins: |
            poetry-dynamic-versioning[plugin]
            poethepoet[poetry_plugin]

      # Install and cache test-only dependencies
      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root --with test --no-plugins

      # Grab the built artifacts to ensure we're testing what we eventually publish
      - name: Download Python dist
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist
    
      - name: Download WebUI dist
        uses: actions/download-artifact@v4
        with:
          name: webui-dist
          path: locust/webui/dist

      # Run tests!
      - name: Run tox tests
        run: |
          source $VENV
          tox -e ${{ matrix.tox }} --installpkg dist/*.whl

  lint_typecheck_test_webui:
    name: Web UI Lint and Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'yarn'
          cache-dependency-path: locust/webui/yarn.lock
      - uses: borales/actions-yarn@v5
        with:
          cmd: install
          dir: locust/webui
      - uses: borales/actions-yarn@v5
        with:
          cmd: build
          dir: locust/webui
      - uses: borales/actions-yarn@v5
        with:
          cmd: test
          dir: locust/webui
      - uses: borales/actions-yarn@v5
        with:
          cmd: lint
          dir: locust/webui
      - uses: borales/actions-yarn@v5
        with:
          cmd: type-check
          dir: locust/webui
      
  docker_image_test:
    name: Test Docker Image
    runs-on: ubuntu-latest
    needs: docker_build
    steps:

      # Set up Docker dependencies
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - uses: docker/login-action@v3
        if: github.repository_owner == 'locustio'
        with:
          username: locustbuild
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: locust-docker
          path: /tmp

      # TODO: Run some sort of basic headless test to make sure the binary is OK
      - name: Test built Docker image
        run: |
          docker load --input /tmp/locust-docker.tar
          docker run -it --rm locustio/locust:latest --version

  # -------------------------
  #       Publishing
  # -------------------------

  publish_checkpoint:
    name: Publishing Gate
    needs: [tox_tests, docker_image_test, lint_typecheck_test_webui]
    runs-on: ubuntu-latest
    steps:
      - run: echo Publishing

  # On merge commits to `master`
  publish_prerelease:
    name: Publish prerelease on merge commit to master
    needs: publish_checkpoint
    if: github.ref == 'refs/heads/master' && github.repository_owner == 'locustio' && needs.build_package.outputs.git_is_merge_commit == 'true'
    runs-on: ubuntu-latest
    steps:

      # Download Python dist and publish it
      - name: Download Python dist 
        uses: actions/download-artifact@v4
        with:
          name: python-package-dist
          path: dist
      - name: Publish prerelease version to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      # Download Web UI lib and publish it
      - name: Download UI lib
        uses: actions/download-artifact@v4
        with:
          name: webui-package-dist
          path: locust/webui/lib
      - uses: borales/actions-yarn@v5
        name: Publish package on NPM
        env:
          TAG: ${{ needs.build_package.outputs.tag }}
          NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
        with:
          cmd: publish --no-git-tag-version --non-interactive --tag next --new-version ${{ env.TAG }}-next-${{ github.run_id }}
          dir: locust/webui

      # Download Docker image, tag and push it
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - uses: docker/login-action@v3
        if: github.repository_owner == 'locustio'
        with:
          username: locustbuild
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: locust-docker
          path: /tmp
      - name: Load and push Docker image
        run: |
          docker load --input /tmp/locust-docker.tar
          docker tag locustio/locust:latest locustio/locust:master
          docker push locustio/locust:master 

  # On tag builds
  publish:
    name: Publish Release on Tag
    needs: publish_checkpoint
    if: startsWith(github.event.ref, 'refs/tags') && github.repository_owner == 'locustio'
    runs-on: ubuntu-latest
    steps:

      # Download built Python dist and publish it
      - name: Download Python dist
        uses: actions/download-artifact@v4
        with:
          name: python-package-dist
      - name: Publish tagged version to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true

      # Download built Web UI lib and publish it
      - name: Download UI lib
        uses: actions/download-artifact@v4
        with:
          name: webui-package-dist
          path: locust/webui/lib
      - uses: borales/actions-yarn@v5
        name: Publish package on NPM
        with:
          cmd: publish --no-git-tag-version --non-interactive --new-version ${{ github.ref_name }}
          dir: locust/webui
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}

      # Download Docker image, tag and push it
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - uses: docker/login-action@v3
        if: github.repository_owner == 'locustio'
        with:
          username: locustbuild
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: locust-docker
          path: /tmp

      - name: Load and push tagged Docker image
        env:
          TAG: ${{ needs.build_package.outputs.tag }}
        run: |
          docker load --input /tmp/locust-docker.tar
          docker tag locustio/locust:latest locustio/locust:${{ env.TAG }}
          docker push locustio/locust:${{ env.TAG }}
      - name: Load and push latest Docker image on master 
        if: needs.build_package.outputs.branch == 'master'
        env:
          BRANCH: ${{ needs.build_package.outputs.branch }}
        run: |
          docker push locustio/locust:latest
